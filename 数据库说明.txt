-- 用户表
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '客户ID',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '客户名',
    password VARCHAR(50) NOT NULL COMMENT '登录密码',
    phone VARCHAR(20) COMMENT '联系电话',
    address VARCHAR(200) DEFAULT '未填写' COMMENT '地址',
    balance DECIMAL(10,2) DEFAULT 0.00 COMMENT '账户余额',
    remark TEXT COMMENT '备注',
    permission VARCHAR(20) DEFAULT NULL COMMENT '权限',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    modified_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间'
) COMMENT '用户表';

-- 商品表
CREATE TABLE commodities (
   id INT PRIMARY KEY AUTO_INCREMENT COMMENT '商品ID',
   name VARCHAR(100) NOT NULL COMMENT '商品名称',
   type VARCHAR(50) COMMENT '商品类别',
   detail TEXT COMMENT '商品详情',
   production_date DATE COMMENT '生产日期',
   manufacturer VARCHAR(100) COMMENT '生产商',
   origin VARCHAR(100) COMMENT '产地',
   remark TEXT COMMENT '备注'
) COMMENT '商品表';

-- 商品SKU表
CREATE TABLE skus (
    skuid INT PRIMARY KEY AUTO_INCREMENT COMMENT 'SKU ID',
    commodityid INT NOT NULL COMMENT '商品ID',
    color VARCHAR(50) DEFAULT '默认颜色' COMMENT '颜色',
    style VARCHAR(50) DEFAULT '默认款式' COMMENT '款式',
    price DECIMAL(10,2) NOT NULL COMMENT '单价',
    stock INT NOT NULL DEFAULT 0 COMMENT '库存',
    CONSTRAINT fk_commodity FOREIGN KEY (commodityid) 
        REFERENCES commodities(id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
) COMMENT '商品SKU表';

-- 购物车表
CREATE TABLE cart (
    cartid INT AUTO_INCREMENT COMMENT '购物车ID',
    userid INT NOT NULL COMMENT '客户ID',
    username VARCHAR(50) NOT NULL COMMENT '客户名',
    skuid INT NOT NULL COMMENT '商品SKUID',
    name VARCHAR(100) NOT NULL COMMENT '商品名称',
    type VARCHAR(50) COMMENT '商品类别',
    detail TEXT COMMENT '商品详情',
    color VARCHAR(50) COMMENT '颜色',
    style VARCHAR(50) COMMENT '款式',
    price DECIMAL(10,2) NOT NULL COMMENT '单价',
    num INT NOT NULL COMMENT '数量',
    PRIMARY KEY (userid, skuid),  -- 修改为联合主键
    UNIQUE KEY (cartid),          -- 保留自增ID作为唯一键
    FOREIGN KEY (userid) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (skuid) REFERENCES skus(skuid)
) COMMENT '购物车表';

-- 订单主表
CREATE TABLE orders (
    orderid INT PRIMARY KEY AUTO_INCREMENT COMMENT '订单ID',
    userid INT NOT NULL COMMENT '客户ID',
    total_amount DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '订单总金额',
    status ENUM('待支付', '已支付', '已发货', '已完成', '已取消') NOT NULL DEFAULT '待支付' COMMENT '订单状态',
    shipping_address VARCHAR(200) NOT NULL COMMENT '收货地址',
    payment_method VARCHAR(50) COMMENT '支付方式',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '下单时间',
    payment_time DATETIME COMMENT '支付时间',
    shipped_time DATETIME COMMENT '发货时间',
    completed_time DATETIME COMMENT '完成时间',
    remark TEXT COMMENT '备注',
    FOREIGN KEY (userid) REFERENCES users(id) ON DELETE CASCADE
) COMMENT '订单主表';

-- 订单明细表
CREATE TABLE order_details (
    detail_id INT PRIMARY KEY AUTO_INCREMENT COMMENT '明细ID',
    orderid INT NOT NULL COMMENT '订单ID',
    skuid INT NOT NULL COMMENT '商品SKUID',
    quantity INT NOT NULL CHECK (quantity > 0) COMMENT '数量',
    price DECIMAL(10,2) NOT NULL COMMENT '下单时单价',
    FOREIGN KEY (orderid) REFERENCES orders(orderid) ON DELETE CASCADE
) COMMENT '订单明细表';

-- 创建触发器维护总金额一致性
DELIMITER //

CREATE TRIGGER update_total_after_insert
AFTER INSERT ON order_details
FOR EACH ROW
BEGIN
    UPDATE orders 
    SET total_amount = total_amount + NEW.quantity * NEW.price
    WHERE orderid = NEW.orderid;
END//

CREATE TRIGGER update_total_after_delete
AFTER DELETE ON order_details
FOR EACH ROW
BEGIN
    UPDATE orders 
    SET total_amount = total_amount - OLD.quantity * OLD.price
    WHERE orderid = OLD.orderid;
END//

CREATE TRIGGER update_total_after_update
AFTER UPDATE ON order_details
FOR EACH ROW
BEGIN
    DECLARE diff DECIMAL(10,2);
    SET diff = (NEW.quantity * NEW.price) - (OLD.quantity * OLD.price);
    UPDATE orders 
    SET total_amount = total_amount + diff
    WHERE orderid = NEW.orderid;
END//

DELIMITER ;
